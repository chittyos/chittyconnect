name: Deploy ChittyConnect

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-chittyconnect-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20

jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      #########################################
      # Validation
      #########################################
      - name: Validate OpenAPI
        run: |
          SPEC="openapi.json"
          [ ! -f "$SPEC" ] && [ -f "public/openapi.json" ] && SPEC="public/openapi.json"
          [ -f "$SPEC" ] && npx @redocly/cli lint "$SPEC" || echo "No OpenAPI spec"

      - name: Validate MCP Manifest
        run: |
          [ -f "mcp/manifest.json" ] && [ -f "mcp/manifest.schema.json" ] && \
            npx ajv validate -s mcp/manifest.schema.json -d mcp/manifest.json || \
            echo "MCP manifest validation skipped"

      #########################################
      # D1 Migrations
      #########################################
      - name: Run D1 Migrations
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Running D1 migrations..."
          if [ -d migrations ]; then
            for migration in migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "Applying $migration..."
                npx wrangler d1 execute chittyconnect --file "$migration" --remote || echo "Migration may already be applied"
              fi
            done
          fi

      #########################################
      # Deploy
      #########################################
      - name: Deploy to Production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy

      #########################################
      # Health Checks + Auto-Rollback
      #########################################
      - name: Health Checks
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          sleep 5

          fail() {
            echo "Health check failed - rolling back..."
            npx wrangler rollback -y
            exit 1
          }

          curl -f https://connect.chitty.cc/health || fail
          curl -f https://connect.chitty.cc/.well-known/chitty.json || fail

          echo "Production deployment verified"
