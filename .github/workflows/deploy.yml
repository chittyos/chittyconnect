name: Deploy ChittyConnect

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

permissions:
  contents: read
  id-token: write  # Required for OIDC

concurrency:
  group: deploy-chittyconnect-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20

jobs:
  ###########################################################################
  # 1. Deploy to Staging
  ###########################################################################
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      #########################################
      # Fetch credentials from ChittyConnect
      # Zero secrets stored in GitHub!
      #########################################
      - name: Get Credentials from ChittyConnect
        id: creds
        uses: ./.github/actions/chittyconnect-credentials
        with:
          credentials: CLOUDFLARE_API_TOKEN,CLOUDFLARE_ACCOUNT_ID

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run D1 Migrations (Staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.creds.outputs.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.creds.outputs.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Running D1 migrations for staging..."
          if [ -d migrations ]; then
            for migration in migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "Applying $migration..."
                npx wrangler d1 execute chittyconnect-staging --file "$migration" --remote || echo "Migration may already be applied"
              fi
            done
          fi

      - name: Deploy to Staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.creds.outputs.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.creds.outputs.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy --env staging

      - name: Health Check
        run: |
          sleep 5
          curl -f https://chittyconnect-staging.chitty.workers.dev/health
          curl -f https://chittyconnect-staging.chitty.workers.dev/.well-known/chitty.json
          echo "‚úÖ Staging deployment healthy"

  ###########################################################################
  # 2. Deploy to Production
  ###########################################################################
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      #########################################
      # Fetch credentials from ChittyConnect
      #########################################
      - name: Get Credentials from ChittyConnect
        id: creds
        uses: ./.github/actions/chittyconnect-credentials
        with:
          credentials: CLOUDFLARE_API_TOKEN,CLOUDFLARE_ACCOUNT_ID

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      #########################################
      # Validation
      #########################################
      - name: Validate OpenAPI
        run: |
          SPEC="openapi.json"
          [ ! -f "$SPEC" ] && [ -f "public/openapi.json" ] && SPEC="public/openapi.json"
          [ -f "$SPEC" ] && npx @redocly/cli lint "$SPEC" || echo "‚ö†Ô∏è No OpenAPI spec"

      - name: Validate MCP Manifest
        run: |
          [ -f "mcp/manifest.json" ] && [ -f "mcp/manifest.schema.json" ] && \
            npx ajv validate -s mcp/manifest.schema.json -d mcp/manifest.json || \
            echo "‚ö†Ô∏è MCP manifest validation skipped"

      #########################################
      # D1 Migrations
      #########################################
      - name: Run D1 Migrations (Production)
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.creds.outputs.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.creds.outputs.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Running D1 migrations for production..."
          if [ -d migrations ]; then
            for migration in migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "Applying $migration..."
                npx wrangler d1 execute chittyconnect-production --file "$migration" --remote || echo "Migration may already be applied"
              fi
            done
          fi

      #########################################
      # Deploy
      #########################################
      - name: Deploy to Production
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.creds.outputs.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.creds.outputs.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üöÄ Deploying to production..."
          npx wrangler deploy --env production

      #########################################
      # Health Checks + Auto-Rollback
      #########################################
      - name: Health Checks
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.creds.outputs.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.creds.outputs.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          sleep 5

          fail() {
            echo "‚ùå Health check failed ‚Äî rolling back..."
            npx wrangler rollback --env production -y
            exit 1
          }

          curl -f https://connect.chitty.cc/health || fail
          curl -f https://connect.chitty.cc/.well-known/chitty.json || fail
          curl -f https://connect.chitty.cc/api/health || fail

          echo "‚úÖ Production deployment verified"
