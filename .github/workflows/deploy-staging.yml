name: Deploy to Staging

on:
  push:
    branches: [develop, 'claude/**']
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://connect-staging.chitty.cc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run pre-deployment checks
        run: |
          echo "Running pre-deployment validation..."
          npx wrangler deploy --dry-run --env staging

      - name: Deploy to Cloudflare Workers (Staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          environment: 'staging'
          command: deploy --env staging

      - name: Wait for deployment
        run: sleep 10

      - name: Health check
        run: |
          echo "Running health check on staging..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://connect-staging.chitty.cc/health)
          if [ "$RESPONSE" -eq 200 ]; then
            echo "✓ Health check passed (HTTP $RESPONSE)"
          else
            echo "✗ Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."

          # Test health endpoint
          curl -f https://connect-staging.chitty.cc/health || exit 1

          # Test health with full parameter
          curl -f "https://connect-staging.chitty.cc/health?full=true" || exit 1

          echo "✓ Smoke tests passed"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://connect-staging.chitty.cc" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ✓ Deployed" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Staging deployment failed!"
          echo "Check logs for details"

  post-deployment-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for service stabilization
        run: sleep 5

      - name: Run integration tests
        run: |
          echo "Running integration tests against staging..."

          # Test all public endpoints
          BASE_URL="https://connect-staging.chitty.cc"

          echo "Testing health endpoint..."
          curl -f "$BASE_URL/health" || exit 1

          echo "Testing 404 handling..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/nonexistent")
          if [ "$RESPONSE" -eq 404 ]; then
            echo "✓ 404 handling works"
          else
            echo "✗ 404 handling failed"
            exit 1
          fi

          echo "✓ All integration tests passed"

      - name: Performance check
        run: |
          echo "Running performance checks..."

          # Measure response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" https://connect-staging.chitty.cc/health)
          echo "Response time: ${RESPONSE_TIME}s"

          # Check if under 1 second
          if (( $(echo "$RESPONSE_TIME < 1.0" | bc -l) )); then
            echo "✓ Performance acceptable (<1s)"
          else
            echo "⚠️ Warning: Response time high (>1s)"
          fi

      - name: Test summary
        run: |
          echo "## Post-Deployment Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check:** ✓ Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests:** ✓ Passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** ✓ Acceptable" >> $GITHUB_STEP_SUMMARY
