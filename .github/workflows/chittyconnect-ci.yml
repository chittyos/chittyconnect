name: ChittyConnect CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  actions: read
  packages: read

jobs:
  ###########################################################################
  # 1. Fetch ephemeral credentials (singleton)
  ###########################################################################
  chitty-creds:
    name: Fetch ChittyConnect ephemeral credentials
    runs-on: ubuntu-latest
    outputs:
      gh_token: ${{ steps.chitty.outputs.github_token }}
      npm_token: ${{ steps.chitty.outputs.npm_token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch ChittyConnect ephemeral credentials
        id: chitty
        uses: chittyos/chittyconnect-action@v1
        with:
          api_key: ${{ secrets.CHITTYCONNECT_API_KEY }}
          purpose: github-actions-ci

  ###########################################################################
  # 2. Lint (matrix)
  ###########################################################################
  lint:
    name: Lint
    needs: chitty-creds
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix['node-version'] }}
          cache: npm

      - name: Configure ephemeral npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ needs.chitty-creds.outputs.npm_token }}

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint --if-present

  ###########################################################################
  # 3. Test (matrix)
  ###########################################################################
  test:
    name: Test
    needs: [chitty-creds, lint]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        node-version: [20, 22]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix['node-version'] }}
          cache: npm

      - name: Configure ephemeral npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ needs.chitty-creds.outputs.npm_token }}

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test --if-present

  ###########################################################################
  # 4. Build (single Node version)
  ###########################################################################
  build:
    name: Build
    needs: [chitty-creds, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Configure ephemeral npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        env:
          NPM_TOKEN: ${{ needs.chitty-creds.outputs.npm_token }}

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present
